<!doctype html>
<head>
	<title>Modata Visualization</title>
	<link rel="stylesheet" src="bootstrap-min.css">
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
	<style>

	body {
		font-family: sans-serif;
	}

	#contacts {
		width: 200px;
		position: fixed;
	}

	#contacts ul li {
		list-style-type: none;
		font-size: 10pt;
		line-height: 1.2em;
	}

	#keys {
		font-size: 8pt;
		font-family: "Menlo", monospace;
		width: 400px;
		position: fixed;
		right: 10px;
	}

	#keys ul li {
		list-style-type: none;
		line-height: 1.5em;
		display: block;
	}

	svg {
		width: 100%;
		border: 1px solid #000;
	}

	.node {
	  stroke: #fff;
	  stroke-width: 1.5px;
	}

	.node:after {
		content: attr(data-label);
		display: block;
		color: black;
	}

	.link {
	  stroke: #999;
	  stroke-opacity: .6;
	}

	</style>

	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

	<script>

var statserver = "";

function plotContacts(nodes, links) {
	// Adapted from D3 example code: http://bl.ocks.org/mbostock/4062045
	var width = 700,
	    height = 500;

	var color = d3.scale.category20();

	var force = d3.layout.force()
	    .charge(-120)
	    .linkDistance(30)
	    .size([width, height]);

	var svg = d3.select("body").append("svg")
	    .attr("width", width)
	    .attr("height", height);

	force
	  .nodes(nodes)
	  .links(links)
	  .start();

	var link = svg.selectAll(".link")
	  .data(links)
	.enter().append("line")
	  .attr("class", "link")
	  .style("stroke-width", function(d) { return Math.sqrt(d.value); });

	var node = svg.selectAll(".node")
	  .data(force.nodes())
	.enter().append("circle")
	  .attr("class", "node")
	  .attr("r", 5)
	  .attr("data-label", function(d) { return d.Port })
  	  .style("fill", function(d) { return color(d.Addr + ":" + d.Port); })
	  .call(force.drag)

	node.append("title")
	  .text(function(d) { return d.Addr + ":" + d.Port; });

	force.on("tick", function() {
	link.attr("x1", function(d) { return d.source.x; })
	    .attr("y1", function(d) { return d.source.y; })
	    .attr("x2", function(d) { return d.target.x; })
	    .attr("y2", function(d) { return d.target.y; });

	node.attr("cx", function(d) { return d.x; })
	    .attr("cy", function(d) { return d.y; });
	});

	// Make legend
	var nodeTable = d3.select("#contacts").append("ul");
	var nodeLis = nodeTable.selectAll(".nodeLegend")
	  .data(nodes)
	  .enter().append("li")
	    .text(function(n) { return n.Addr + ":" + n.Port; })
	    .style("color", function(n) { return color(n.Port); })

	// Do shit with keys
	$.getJSON(statserver + "/keymap", {}, function(data, textStatus, jqXHR) {
		keys = Object.keys(data.data.keys).map(function(k) { return {key: k, nodes: data.data.keys[k].nodes, replicationCount: data.data.keys[k].replicationCount }});

		var keyTable = d3.select("#keys").append("ul");
		var keyLis = keyTable.selectAll(".keyLengend")
		  .data(keys)
		  .enter().append("li")
		    .text(function(k) { return k.key + " (" + k.replicationCount + ")" })
		    .style("color", "black")
		    .on("mouseenter", function(k, i) {
		    	node.filter(function(n) { 
		    		var addr = "http://" + n.Addr + ":" + n.Port;
		    		for (var i = 0; i < k.nodes.length; i++) {
		    			if (k.nodes[i] == addr) {
		    				return true;
		    			}
		    		}
		    		return false;
		    	})
		    	  .style("fill", "red")
		    })
		    
		    .on("mouseleave", function(k, i) {
		    	node.filter(function(n) { 
		    		var addr = "http://" + n.Addr + ":" + n.Port;
		    		for (var i = 0; i < k.nodes.length; i++) {
		    			if (k.nodes[i] == addr) {
		    				return true;
		    			}
		    		}
		    		return false;
		    	})
		    	  .style("fill", function(d) { return color(d.Addr + ":" + d.Port); })
		    })

		    ;
	});
}

window.onload = function() {
	$.getJSON(statserver + "/contacts", {}, function(data, textStatus, jqXHR) {
		
		var nodeList = data.data;
		var connections = [];

		function findNode(n) {
			for (var i = 0; i < nodeList.length; i++) {
				if (nodeList[i].Addr == n.Addr && nodeList[i].Port == n.Port) {
					return i;
				}
			}
			nodeList.push(n);
			return nodeList.length - 1;
		}


		var l = nodeList.length;	// May increase as we find more nodes, don't want to scan the new ones
		var done = 0;
		var i = 0;
		nodeList.map(function(n) {
			var addr = "http://" + nodeList[i].Addr + ":" + (parseInt(nodeList[i].Port) + (1337 - 1234));
			i++;
			// Replication server port for blockserver

			$.getJSON(addr + "/contacts", {}, function(data, textStatus, jqXHR) {
				var contacts = data.data;
				contacts.map(function(e) {
					var i = findNode(n);
					var j = findNode(e);
					connections.push({source: i, target: j, value: 1});
				});

				if (++done == l) {
					plotContacts(nodeList, connections);
				}
			});
		});
	});
}

	</script>
</head>
<body>

	<div id="contacts"></div>
	<div id="keys"></div>

</body>
</html>